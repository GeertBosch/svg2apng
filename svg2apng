#!/usr/bin/env node

const puppeteer = require('puppeteer');
const fs = require('fs');
const { execSync } = require('child_process');
const path = require('path');
const { program } = require('commander');

program
  .argument('<filePath>', 'path to the SVG file')
  .option('-o, --output <output>', 'output file name')
  .parse(process.argv);

const filePath = program.args[0];
const outputFileName = program.opts().output || 'output.apng';

if (!filePath) {
  console.error('Please provide the path to the SVG file as an argument.');
  process.exit(1);
}

const absoluteFilePath = path.resolve(filePath);

(async () => {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  await page.goto(`file://${absoluteFilePath}`);

  const frames = 10; // Number of frames to capture
  const delay = 100; // Delay between frames in milliseconds

  for (let i = 0; i < frames; i++) {
    const framePath = `frame-${i}.png`;
    await page.screenshot({ path: framePath });
    await new Promise(resolve => setTimeout(resolve, delay));
  }

  execSync(`apngasm --force -o ${outputFileName} frame-*.png`);
  console.log(`APNG file created: ${outputFileName}`);

  // Remove frame-*.png files
  for (let i = 0; i < frames; i++) {
    const framePath = `frame-${i}.png`;
    fs.unlinkSync(framePath);
  }

  await browser.close();
})();